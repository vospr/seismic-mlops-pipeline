name: ML Pipeline CI/CD

# TRIGGER: Only when raw data files are added or workflow manually triggered
on:
  push:
    branches: [ main ]
    paths:
      - 'data/raw/**'           # Only trigger when raw data files change
      - 'data/raw/*.sgy'        # SGY files added
      - 'data/raw/*.parquet'    # Parquet files added
  workflow_dispatch:            # Manual trigger button
    inputs:
      run_full_pipeline:
        description: 'Run full pipeline (true/false)'
        required: false
        default: 'false'

jobs:
  # Job 1: Quick validation (always runs)
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Check raw data exists
        id: check_data
        run: |
          if [ -d "data/raw" ] && [ "$(ls -A data/raw 2>/dev/null)" ]; then
            echo "data_exists=true" >> $GITHUB_OUTPUT
            echo "✅ Raw data found in data/raw/"
            ls -la data/raw/
          else
            echo "data_exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ No raw data found - skipping pipeline stages"
          fi
      
      - name: Validate Python syntax
        run: |
          python -m py_compile src/stage0_data_sampling.py
          python -m py_compile src/stage1_data_ingestion.py
          python -m py_compile src/stage2_feature_engineering.py
          python -m py_compile src/stage3_model_training.py
          python -m py_compile src/stage4_model_evaluation.py
          echo "✅ All Python files have valid syntax"

  # Job 2: Run pipeline (only if data exists and manual trigger)
  run_pipeline:
    needs: validate
    runs-on: ubuntu-latest
    if: github.event.inputs.run_full_pipeline == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Run Stage 0 - Data Sampling
        run: python src/stage0_data_sampling.py
        continue-on-error: true
      
      - name: Run Stage 1 - Data Ingestion
        run: python src/stage1_data_ingestion.py
        continue-on-error: true
      
      - name: Run Stage 2 - Feature Engineering
        run: python src/stage2_feature_engineering.py
        continue-on-error: true
      
      - name: Run Stage 3 - Model Training
        run: python src/stage3_model_training.py
        continue-on-error: true
      
      - name: Run Stage 4 - Model Evaluation
        run: python src/stage4_model_evaluation.py
        continue-on-error: true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: model-artifacts
          path: |
            models/
            data/gold/
        if: always()
